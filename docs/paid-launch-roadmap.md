## 付费上线路线图（Lottery API）

本文件概述从当前开源/免费形态演进到对外收费（SaaS/API）的最小可行版本（MVP）与扩展阶段所需的功能、架构、安全、合规与运营准备项。内容按“必须 → 应该 → 可选”优先级排列，并给出阶段里程碑与验收清单。

### 一、产品与定价（Product & Pricing）
- **套餐分层（必须）**：Free（限速/延迟/仅最近若干期）、Pro（实时、较高配额）、Business（更高配额/优先支持/专属线路）、Enterprise（SLA/私有化/定制源）。
- **计费维度（必须）**：按请求数（API calls）、并发/速率、可访问彩种数量、历史期数深度、Webhooks 数量、数据导出额度。
- **支付与账单（必须）**：Stripe（国际信用卡）、支付宝/微信（可选，面向国内用户）；开票/发票下载；失败重扣与欠费停机策略。
- **试用/优惠（应该）**：7~14 天试用、优惠码、按月/按年（年付折扣）。

### 二、账号体系与权限（Auth & Accounts）
- **登录注册（必须）**：Email+密码、社交登录（GitHub/Google 可选）。
- **邮箱校验与找回（必须）**：注册验证、重置密码、邮件黑名单与速率限制。
- **RBAC（应该）**：Owner/Admin/Member；团队/组织多成员协作。
- **2FA（可选）**：TOTP 或短信二次验证。

### 三、API 产品化（API-as-a-Product）
- **API Key 发行与管理（必须）**：创建/禁用/轮换；只读/读写（如管理 Webhook）。
- **速率限制与配额（必须）**：按套餐配置速率（RPM/RPS）与总额（每日/每月）；超限返回 429 并带重试提示。
- **版本化（必须）**：`/v1` 起，变更通过新版本发布；弃用策略与时间表。
- **开发者文档（必须）**：参考文档与示例（cURL、Node、Python、PHP）、错误码、SDK（应对常用语言提供最小封装）。
- **Webhook（应该）**：开奖事件推送；签名验证（HMAC）；重试与死信队列；可视化送达日志。
- **导出（应该）**：CSV/JSON 历史数据下载（按套餐限制）；异步导出与邮件通知。

### 四、数据质量与来源治理（Data Quality & Sources）
- **采集链路冗余（必须）**：每彩种至少 2 个数据源；失败自动切换；源可信度打分与回填策略。
- **一致性与纠错（必须）**：同期开奖多源比对；差异告警与人工校正后台；校正审计日志。
- **延迟与时效（必须）**：采集到展示/推送的端到端延迟指标；超阈值告警。
- **历史回填（应该）**：缺失期数补齐任务；防重复（幂等键）。

### 五、前端与控制台（Console & UX）
- **订阅与结算页（必须）**：价格页、结算/升级/降级/取消、自助开票；发票与账单中心。
- **使用量仪表盘（必须）**：当月用量、速率峰值、失败比例、Webhook 成功率；导出日志。
- **彩种管理（应该）**：可见彩种、关注彩种、区域/时间筛选；搜索与收藏。
- **状态页（应该）**：`/status` 展示数据源健康、最近事件；可接入第三方（Better Stack/Statuspage）。

### 六、后端架构与可观测性（Backend & Observability）
- **任务队列与定时（必须）**：采集器 → 队列（如 BullMQ/RabbitMQ）→ 解析入库；Cron 定时刷新与重试。
- **缓存层（必须）**：Redis 作为热点期数与列表缓存；SWR/stale-while-revalidate 策略；全站 CDN。
- **数据库（必须）**：核心表（示例）
  - `users`、`teams`、`subscriptions`、`plans`、`invoices`
  - `api_keys`、`api_usage`、`rate_limits`
  - `lottery_results`、`lottery_sources`、`fetch_jobs`、`audit_logs`
- **可观测性（必须）**：结构化日志、分布式追踪、指标（采集时延、错误率、吞吐）；告警（PagerDuty/钉钉/企业微信）。
- **灰度与开关（应该）**：Feature Flags；只读维护模式；回滚预案。

### 七、安全（Security）
- **基础安全（必须）**：OWASP Top 10；输入校验；CSRF/CORS；Helmet/CSP；安全 Header；HTTPS 全站；会话固定/劫持防护。
- **秘密管理（必须）**：API Key/密钥存储在 KMS/Secrets Manager；严禁日志打出敏感信息。
- **防滥用（必须）**：IP 速率限制、机器人防护、异常流量黑名单；注册/登录/支付多重速率限制。
- **审计与追踪（应该）**：敏感操作审计；管理员操作留痕。
- **合规（应该）**：GDPR/CCPA 数据删除与导出；Cookie 同意；隐私与条款页面。

### 八、法务与许可（Legal）
- **免责声明（必须）**：数据仅供参考，非官方认证；因源站延迟/错误造成的损失不承担责任；严禁用于违法博彩。
- **使用条款与隐私（必须）**：ToS/Privacy；API 许可协议；可接受使用策略（AUP）。
- **数据来源授权（应该）**：与源站或数据提供商签约/遵循使用条款；爬取频率/版权合规。

### 九、性能与扩展（Performance & Scale）
- **扩展策略（必须）**：读写分离；热点 Key 隔离；批量入库；指数回退重试与幂等。
- **前端性能（应该）**：SSR/ISR；关键路径预加载；图片与图标优化；骨架屏。

### 十、支持与运营（Support & Ops）
- **客服通道（必须）**：工单系统（Zendesk/Freshdesk）或邮箱；SLA 响应时间（按套餐）。
- **知识库（应该）**：FAQ、故障排查、限流与错误码说明、示例代码库。
- **变更日志（应该）**：/changelog；邮件/站内信发布；重大变更提前公告。

### 十一、里程碑规划（Milestones）
1) **Phase 0 稳定化（1–2 周）**
   - 修复已知 UI/数据问题；完成采集冗余与缓存；核心指标/日志/告警上线。
   - 建立速率限制与 API Key；文档雏形；状态页雏形。

2) **Phase 1 付费 MVP（2–4 周）**
   - 支付/订阅与账单中心；套餐与配额策略落地；超额处理。
   - 开发者文档完善、示例与 SDK（至少 Node/Python）。
   - 使用量仪表盘与 Webhook v1；ToS/Privacy/免责声明发布。

3) **Phase 2 增强与增长（4–8 周）**
   - 团队/组织、2FA、企业套餐与发票；多源可信度模型、人工校正后台。
   - 导出中心、历史深度购买、告警订阅（邮件/短信/Telegram/企业微信）。
   - 市场与渠道合作、推广落地页、推荐奖励。

### 十二、验收清单（Launch Checklist）
- [ ] 价格页与结算流全链路可用（成功/失败/退款/降级/升级）
- [ ] API Key 生命周期（创建/禁用/轮换）与速率限制策略生效
- [ ] 开奖数据“多源一致性”达标与异常告警闭环
- [ ] 文档、SDK、示例与错误码完整可用
- [ ] 使用量/账单/发票/邮件通知跑通
- [ ] 状态页、变更日志与支持渠道上线
- [ ] ToS/Privacy/免责声明与 Cookie 同意到位
- [ ] 安全基线（CSP、Headers、XSS/SQLi 扫描、Secrets）通过

### 十三、核心指标（KPIs）
- **产品**：留存/转化（试用→付费）、付费率、退款率、ARPU、LTV。
- **技术**：端到端延迟、错误率、SLO 达标率、采集成功率、Webhook 送达率。
- **风控**：滥用阻断数、异常流量峰值、Key 盗用告警次数。

### 十四、当前代码库建议落地项（结合本仓库）
- 新增 `api/keys`、`api/usage`、`api/webhooks`、`billing` 相关后端接口与数据表。
- 集成 Redis 速率限制与用量计数；为 `app/page.tsx` 列表接口加缓存层与 SWR。
- 新增控制台页：价格/结算、用量仪表盘、Webhook 管理、API Keys 管理。
- 文档站（可用 Next.js 静态导出或 Docusaurus）与示例仓库。

如需，我可以基于以上清单直接拆分任务并开始实现 MVP 所需的接口、数据表与前端控制台。


